package cz.wrent.advent

import kotlin.math.max
import kotlin.math.min

fun main() {
    println(dayElevenPartOne(input, 2))
    println(dayElevenPartOne(input, 1000000))
}

fun dayElevenPartOne(input: String, multiplier: Long): Long {
    val parsed = input.split("\n")
        .map { it.split("").filter { it.isNotBlank() } }
    return solveClever(parsed, multiplier)
    // return solveStupid(parsed)
}

private fun solveClever(map: List<List<String>>, multiplier: Long): Long {
    val expandedRows = map.mapIndexedNotNull { index, it -> if (it.contains("#")) null else index }.toSet()
    val expandedColumns = (0 until map.first().size)
        .mapNotNull { column -> if (map.none { it[column] == "#" }) column else null }.toSet()

    val pairs = galaxyPairs(map)
    return pairs.map {
        val list = it.toList()
        val a = list.get(0)
        val b = list.get(1)
        a.distanceTo(b) + addRows(a, b, expandedRows, multiplier) + addColumns(a, b, expandedColumns, multiplier)
    }.sum()
}

private fun addRows(a: Position, b: Position, expandedRows: Set<Int>, multiplier: Long): Long {
    val range = min(a.y, b.y)..max(a.y, b.y)
    return expandedRows.filter { range.contains(it) }.map { multiplier - 1}.sum()
}

private fun addColumns(a: Position, b: Position, expandedColumns: Set<Int>, multiplier: Long): Long {
    val range = min(a.x, b.x)..max(a.x, b.x)
    return expandedColumns.filter { range.contains(it) }.map { multiplier - 1}.sum()
}

private fun solveStupid(parsed: List<List<String>>): Int {
    val map = parsed.expandRows().expandColumns()

    // println(parsed.map { it.joinToString(separator = "") }.joinToString(separator = "\n"))
    //
    // println()
    // println()
    // println(map.map { it.joinToString(separator = "") }.joinToString(separator = "\n"))

    val pairs = galaxyPairs(map)
    return pairs.map {
        val list = it.toList()
        list.get(0).distanceTo(list.get(1))
    }.sum()
}

private fun galaxyPairs(input: List<List<String>>): Set<Set<Position>> {
    val galaxies = mutableListOf<Position>()

    input.forEachIndexed { y, list ->
        list.forEachIndexed { x, str ->
            if (str == "#") galaxies.add(Position(x, y))
        }
    }

    val pairs = mutableSetOf<Set<Position>>()
    galaxies.forEach { galaxyA ->
        galaxies.forEach { galaxyB ->
            pairs.add(setOf(galaxyA, galaxyB))
        }
    }
    pairs.removeIf { it.size < 2 }

    // println(pairs.size)
    return pairs
}

private fun List<List<String>>.expandRows(): List<List<String>> {
    val list = mutableListOf<List<String>>()

    for (row in this) {
        list.add(row)
        if (!row.contains("#")) {
            list.add(row)
        }
    }

    return list
}

private fun List<List<String>>.expandColumns(): List<List<String>> {
    val list = this.map { mutableListOf<String>() }

    for (column in 0 until this.first().size) {
        for (rowIndex in 0 until this.size) {
            val row = this[rowIndex]
            val str = row.get(column)
            if (this.map { it[column] }.none { it == "#" }) {
                list.forEach { it.add(str) }
                list.forEach { it.add(str) }
                break
            }
            list[rowIndex].add(str)
        }
    }
    return list
}

private const val input =
    """......................#..................#................................#............#..........................#.........................
..........#....................................#.................#..........................................................................
................................#......................#..........................#.....................#................#..................
...........................#....................................................................#........................................#..
.....#..........#...................................................................................................................#.......
........................................................................................#...................................................
........................................#............#......................................................................................
.....................#....................................................#...................#.......................#.....................
..............................................................................................................................#...........#.
............................#.......#......................#................................................................................
...........#......................................#..............#............#.............................................................
.........................................................................................#..................................................
....#...............................................................................#.....................................#...........#.....
..................#...........#...............#..............................................#.......#........#.............................
........................................#...........................#.......................................................................
............................................................................................................................................
.........................#..........................#.........................#.........................#...................................
................#...................#..................................................................................#...................#
...#...........................................................#........#.............#..............................................#......
..................................................................................................#.........................................
.............#..............................#...............................................................................................
.....................#.........................................................................................#............................
............................#........................#............#.........................#..................................#............
.......#..............................................................................................................#.....................
........................................................................#........#..................#.......................................
...#......................................#.......#......................................................#........#...............#.........
...........................................................#.............................................................................#..
................................#..................................#........................................................................
.............#.................................#............................................................................................
#.......................#...............#.................................#...........#.........#...................................#.......
...........................................................................................#..................#.............................
........#....................#........................................................................................#......#..............
............................................................#......................................#......................................#.
..#.......................................#.................................................................................................
....................#................................................................#....................................#........#........
.............#......................#................#......................................#...............................................
.......#............................................................#................................................#......................
..............................#.................#.................................................#.........................................
.......................#...................................................................................#................................
..................#..........................................#..................................................#..............#.....#......
...................................................#...............................#.....#.............#....................................
...#..........#.............#........#......................................................................................................
............................................................................#..................#.............#...........................#..
......................................................#..............#......................................................................
#......#....................................................................................................................#...............
..............................................#.............................................................................................
...................#................#...................................#.......................................................#..........#
...........#............#.................................#.................................................#...........#...................
.....................................................................................#.....#........#............#.....................#....
....................................................#..........#............................................................................
............................................................................................................................................
.#.......#..................#..........#.............................#............#............#..........#................#..............#.
...............#.....#...................................................................#..................................................
.................................................#..........................#.........................................#........#.....#......
......#..........................................................#...............................................#..........................
............................................................................................................................................
.............................#................#.......................................#.....................#...............................
..................#..................#.......................#..........#.....................#.............................#...............
............................................................................................................................................
..................................................................................#.................#...................#..........#........
..................................#.....#..............#..........#.....................#...................................................
.....#.................#....................................................................................................................
#......................................................................................................................................#....
..................#..................#........#...........#..................#.................#............................................
.....................................................................#................................#.........#.............#.............
..........#..........................................................................#.....#................................................
............................#.......................#...........#...........................................................................
.#.................................#.............................................................#.................#........................
............................................................................#................................#..........................#...
......#..................................................................................................................#..................
...................#..............................#.................................................#.........................#.............
..............#................#.........................................................#..........................................#.......
............................................#....................#...............#..........................................................
.......................#................................................#.................................#.................................
..................................#.....#...........#...................................................................#...................
.#.....................................................................................#........#...........................................
.......#......................#................................#.......................................#....................................
...............................................#............................................................................................
..........................................................#................#.....................................#..........................
......................#.....................................................................................................................
............................................#.........#.......................................#..................................#..........
.#.........#........................................................#...................................#.....#.............................
.......................................#.............................................#..................................................#...
...............................#............................................................................................................
.............................................................................#..................#................#........#.................
......................#.....................................................................................................................
...#..............................................#.........#.....................#......................#...........................#......
..................................#.........................................................................................................
...........................................................................#...............#...................................#............
..........#..............#....................#.............................................................................................
...............................................................................................................#........................#...
....#.........#...............................................................#.....#.......................................................
.......................................................#..........#.......................................................#.................
..................................#...............#..............................................................................#..........
..............................................................#..........................#................#.........#.......................
........#............................................................#......................................................................
#...............................................................................................#...........................................
......................#....................................................................................................................#
.....#......................#..............................................#...........#..........................#.....#...................
................#.................................................#..............#..........................................................
...........#.........................................#......................................................................................
..#..................................#.............................................................................................#.....#..
..........................................#................................................#.....#........#.................................
..............#...............................................#.................................................#...........................
....................#.............#....................#..............................................#.....................................
.............................#..........................................#...................................................................
...........................................................#................................................................................
.......................#.........................#.....................................#...........#........................................
.................................................................#............................................#.......#.....................
........#.....#............................................................#........................................................#.......
.................................#...........................................................#..............................................
.#.................#......................#.................#.........#..................................#.......#........#................#
...........#................................................................................................................................
........................#..............................#.............................#......................................................
...................................#.....................................#.........................#.................................#......
............................................................................................................................................
....#..................................#.................................................#...............................#..................
.............................#....................#......................................................................................#..
.............................................................................#.........................#....................................
.............#.....#......................#.......................#.................#........................................#..............
......................................................................................................................................#.....
...#.................................................#...........................................#..........................................
......................#.....................................#...............................................................................
................#..........#..................................................................................#..........#..................
..........#.........................#............#.................#..........#............................................................#
............................................................................................................................................
.......................................................#............................................................#.......................
...#.........................................#.....................................#...............#..............................#.........
............#.........................#.....................................................................................................
.......................#...........................#.....................................................#..................................
..............................................................#............................#...............................#..........#.....
.........#......................#..........#.........................................#......................................................
...............#................................................................................#.....#.....................................
....#.......................#..................#....................#......................................#...................#............
..........................................................#.................................................................................
.....................................#.........................#.........................#..................................................
#..........................................................................#................................................................
...........................................#..................................................................#........#...........#........
......................#...........................................................#...................#.....................................
....#...........#................................................................................#.........................................."""
